

#-------------------------------------------------------
#  Tags defined in this playbook
#    - json
#    - yaml
#    - var
#    - input
#    - negative
#    - param
#-------------------------------------------------------

---
- name: Test aos_ip_pool module
  hosts: aos-server
  connection: local
  gather_facts: no
  vars:
    session_wrong_token:
      server: "{{address}}"
      port: "{{port}}"
      token: "WRONGTOKEN"

  tasks:
#-------------------------------------------------------
# TESTS 000 - Open Session
#-------------------------------------------------------
    - name: Open Session on AOS Server
      uri:
        url: "http://{{address}}:{{port}}/api/user/login"
        method: POST
        status_code: 201
        HEADER_Content-Type: 'application/json'
        HEADER_Accept: 'application/json'
        body: >
          {
            "username": "{{username}}",
            "password": "{{password}}"
          }
        body_format: json
      register: session
      tags: [ yaml, json, var, input ]

    - name: Format token into session_ok variable
      set_fact:
        session_ok:
          server: "{{address}}"
          port: "{{port}}"
          token: "{{session.json.token}}"
      tags: [ yaml, json, var, input ]
#-------------------------------------------------------
# TESTS 100 - Wrong Inputs
#-------------------------------------------------------
    - name: "TEST 101 - Session is mandatory"
      aos_ip_pool:
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: present
      register: test
      ignore_errors: True
      tags: [ negative, param ]

    # - debug: var=test
    - name: Check TEST 101
      assert:
        that:
          - test|failed
          - "test.msg.find('missing required arguments') != -1"
      tags: [ negative, param ]
#-------------------------------------------------------
    - name: "TEST 102 - Name and ID are mutually exclusive"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "myName"
        id: "myID"
        subnets: [ 172.10.0.0/16 ]
        state: present
      register: test
      ignore_errors: True
      tags: [ negative, param ]

    # - debug: var=test102
    - name: Check TEST 102
      assert:
        that:
          - test|failed
          - "test.msg.find('parameters are mutually exclusive') != -1"
      tags: [ negative, param ]
#-------------------------------------------------------
    - name: "TEST 103 - Session is a dict"
      aos_ip_pool:
        session: "my-session"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: present
      register: test
      ignore_errors: True
      tags: [ negative, param ]

    # - debug: var=test
    - name: Check TEST 103
      assert:
        that:
          - test|failed
          - "test.msg.find('argument session is of type') != -1"
      tags: [ negative, param ]
#-------------------------------------------------------

    - name: "TEST 104 - Session is not valid"
      aos_ip_pool:
        session: "{{ session_wrong_token }}"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: present
      register: test
      ignore_errors: True
      tags: [ negative, param ]

    # - debug: var=test
    - name: Check TEST 104
      assert:
        that:
          - test|failed
          - "test.msg.find('Unable to login to the AOS server') != -1"
      tags: [ negative, param ]
#-------------------------------------------------------
# TESTS 200 - Valid Inputs
#-------------------------------------------------------

    - name: "SETUP 200 - Cleanup existing server"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        state: absent
      register: test
      ignore_errors: True
      tags: [ input ]

    # - debug: var=test

    - name: Check TEST 200
      assert:
        that:
          - test|success
      tags: [ input ]
#-------------------------------------------------------
    - name: "TEST 201 - Create IP Pool - Check mode 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: present
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ input ]

    - name: Check TEST 201
      assert:
        that:
          - test|success
          - test|changed
      tags: [ input ]
#-------------------------------------------------------
    - name: "TEST 202 - Create IP Pool - Check mode 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: present
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ input ]

    - name: Check TEST 202
      assert:
        that:
          - test|success
          - test|changed
      tags: [ input ]

#-------------------------------------------------------
    - name: "TEST 203 - Create IP Pool - 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: present
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ input ]

    - name: Check TEST 203
      assert:
        that:
          - test|success
          - test|changed
      tags: [ input ]

#-------------------------------------------------------
    - name: "TEST 204 - Create IP Pool - 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: present
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ input ]

    - name: Check TEST 204
      assert:
        that:
          - test|success
          - not test|changed
      tags: [ input ]

#-------------------------------------------------------
    - name: "TEST 205 - Create IP Pool - Check mode when exist"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: present
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ input ]

    - name: Check TEST 205
      assert:
        that:
          - test|success
          - not test|changed
      tags: [ input ]

#-------------------------------------------------------
    - name: "TEST 206 - Delete IP Pool - Check mode when exist"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: absent
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ input ]

    - name: Check TEST 206
      assert:
        that:
          - test|success
          - test|changed
      tags: [ input ]

#-------------------------------------------------------
    - name: "TEST 207 - Delete IP Pool - 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: absent
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ input ]

    - name: Check TEST 207
      assert:
        that:
          - test|success
          - test|changed
      tags: [ input ]

#-------------------------------------------------------
    - name: "TEST 208 - Delete IP Pool - 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: absent
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ input ]

    - name: Check TEST 208
      assert:
        that:
          - test|success
          - not test|changed
      tags: [ input ]
#-------------------------------------------------------
    - name: "TEST 209 - Delete IP Pool - Check mode when absent"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16 ]
        state: absent
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ input ]

    - name: Check TEST 209
      assert:
        that:
          - test|success
          - not test|changed
      tags: [ input ]
#-------------------------------------------------------
    - name: "INIT 210 - Create IP Pool"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        subnets: [ 172.10.0.0/16, 172.12.0.0/16 ]
        state: present
      register: ippool
      check_mode: no
      ignore_errors: True
      tags: [ json, yaml ]

    - name: Check TEST 210
      assert:
        that:
          - ippool|success
          - ippool|changed
      tags: [ json, yaml ]

#-------------------------------------------------------
    - name: "TEST 210.1 - Save Ip Pool into a file in JSON"
      copy:
        content: "{{ ippool.value | to_nice_json }}"
        dest: resources/ip_pool_saved.json
      register: test
      ignore_errors: True
      tags: [ json ]

    - name: Check TEST 210.1
      assert:
        that:
          - test|success
      tags: [ json ]
#-------------------------------------------------------
    - name: "TEST 210.2 - Save Ip Pool into a file in YAML"
      copy:
        content: "{{ ippool.value | to_nice_yaml }}"
        dest: resources/ip_pool_saved.yaml
      register: test
      ignore_errors: True
      tags: [ yaml ]

    - name: Check TEST 210.2
      assert:
        that:
          - test|success
      tags: [ yaml ]
#-------------------------------------------------------
    - name: "INIT 211 - Delete IP Pool"
      aos_ip_pool:
        session: "{{ session_ok }}"
        name: "my-ip-pool"
        state: absent
      register: test
      ignore_errors: True
      tags: [ json ]

    - name: Check Init TEST 211
      assert:
        that:
          - test|success
          - test|changed
      tags: [ json ]
#-------------------------------------------------------
    - name: "TEST 211 - Load Ip Pool from file (Json), Check Mode 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.json') }}"
        state: present
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ json ]

    - name: Check TEST 211
      assert:
        that:
          - test|success
          - test|changed
      tags: [ json ]
#-------------------------------------------------------
    - name: "TEST 212 - Load Ip Pool from file (Json), Check Mode 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.json') }}"
        state: present
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ json ]

    - name: Check TEST 212
      assert:
        that:
          - test|success
          - test|changed
      tags: [ json ]

#-------------------------------------------------------
    - name: "TEST 213 - Load Ip Pool from file(JSON), 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.json') }}"
        state: present
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ json ]

    - name: Check TEST 213
      assert:
        that:
          - test|success
          - test|changed
      tags: [ json ]

#-------------------------------------------------------
    - name: "TEST 214 - Load Ip Pool from File(JSON), 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.json') }}"
        state: present
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ json ]

    - name: Check TEST 214
      assert:
        that:
          - test|success
          - not test|changed
      tags: [ json ]

#-------------------------------------------------------
    - name: "TEST 215 - Delete IP Pool from File(JSON), Check Mode 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.json') }}"
        state: absent
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ json ]

    - name: Check TEST 215
      assert:
        that:
          - test|success
          - test|changed
      tags: [ json ]
#-------------------------------------------------------
    - name: "TEST 216 - Delete IP Pool from File(JSON), Check Mode 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.json') }}"
        state: absent
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ json ]

    - name: Check Init TEST 216
      assert:
        that:
          - test|success
          - test|changed
      tags: [ json ]

#-------------------------------------------------------
    - name: "TEST 217 - Delete IP Pool from File(JSON), 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.json') }}"
        state: absent
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ json ]

    - name: Check Init TEST 217
      assert:
        that:
          - test|success
          - test|changed
      tags: [ json ]

#-------------------------------------------------------
    - name: "TEST 218 - Delete IP Pool from File(JSON), 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.json') }}"
        state: absent
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ json ]

    - name: Check Init TEST 218
      assert:
        that:
          - test|success
          - not test|changed
      tags: [ json ]

#-------------------------------------------------------
#-------------------------------------------------------
    - name: "TEST 221 - Load Ip Pool from file (Yaml), Check Mode 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.yaml') }}"
        # content_format: yaml
        state: present
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ yaml ]

    - name: Check TEST 221
      assert:
        that:
          - test|success
          - test|changed
      tags: [ yaml ]

#-------------------------------------------------------
    - name: "TEST 222 - Load Ip Pool from file (Yaml), Check Mode 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.yaml') }}"
        # content_format: yaml
        state: present
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ yaml ]

    - name: Check TEST 222
      assert:
        that:
          - test|success
          - test|changed
      tags: [ yaml ]

#-------------------------------------------------------
    - name: "TEST 223 - Load Ip Pool from file(Yaml), 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.yaml') }}"
        # content_format: yaml
        state: present
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ yaml ]

    - name: Check TEST 223
      assert:
        that:
          - test|success
          - test|changed
      tags: [ yaml ]

#-------------------------------------------------------
    - name: "TEST 224 - Load Ip Pool from File(Yaml), 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.yaml') }}"
        # content_format: yaml
        state: present
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ yaml ]

    - name: Check TEST 224
      assert:
        that:
          - test|success
          - not test|changed
      tags: [ yaml ]

#-------------------------------------------------------
    - name: "TEST 225 - Delete IP Pool from File(Yaml), Check Mode 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.yaml') }}"
        # content_format: yaml
        state: absent
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ yaml ]

    - name: Check TEST 225
      assert:
        that:
          - test|success
          - test|changed
      tags: [ yaml ]

#-------------------------------------------------------
    - name: "TEST 226 - Delete IP Pool from File(Yaml), Check Mode 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.yaml') }}"
        # content_format: yaml
        state: absent
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ yaml ]

    - name: Check Init TEST 226
      assert:
        that:
          - test|success
          - test|changed
      tags: [ yaml ]

#-------------------------------------------------------
    - name: "TEST 227 - Delete IP Pool from File(Yaml), 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.yaml') }}"
        # content_format: yaml
        state: absent
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ yaml ]

    - name: Check Init TEST 227
      assert:
        that:
          - test|success
          - test|changed
      tags: [ yaml ]
#-------------------------------------------------------
    - name: "TEST 228 - Delete IP Pool from File(Yaml), 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ lookup('file', 'resources/ip_pool_saved.yaml') }}"
        # content_format: yaml
        state: absent
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ yaml ]

    - name: Check Init TEST 228
      assert:
        that:
          - test|success
          - not test|changed
      tags: [ yaml ]
#-------------------------------------------------------
    - name: TEST 230 Create Variable with Content
      set_fact:
        content_var_ok:
          display_name: my-ip-pool
          id: 4276738d-6f86-4034-9656-4bff94a34ea7
          subnets:
            - network: 172.10.0.0/16
            - network: 172.12.0.0/16
      tags: [ var ]
#-------------------------------------------------------
    - name: "TEST 231 - Load Ip Pool from Variable, Check Mode 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content:
          display_name: my-ip-pool
          id: 4276738d-6f86-4034-9656-4bff94a34ea7
          subnets:
            - network: 172.10.0.0/16
            - network: 172.12.0.0/16
        # content_format: var
        state: present
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ var ]

    - name: Check TEST 231
      assert:
        that:
          - test|success
          - test|changed
      tags: [ var ]
#-------------------------------------------------------
    - name: "TEST 232 - Load Ip Pool from Variable, Check Mode 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ content_var_ok }}"
        # content_format: var
        state: present
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ var ]

    - name: Check TEST 232
      assert:
        that:
          - test|success
          - test|changed
      tags: [ var ]

#-------------------------------------------------------
    - name: "TEST 233 - Load Ip Pool from Variable, 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ content_var_ok }}"
        # content_format: var
        state: present
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ var ]

    - name: Check TEST 233
      assert:
        that:
          - test|success
          - test|changed
      tags: [ var ]

#-------------------------------------------------------
    - name: "TEST 234 - Load Ip Pool from Variable, 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ content_var_ok }}"
        # content_format: var
        state: present
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ var ]

    - name: Check TEST 234
      assert:
        that:
          - test|success
          - not test|changed
      tags: [ var ]

#-------------------------------------------------------
    - name: "TEST 235 - Delete IP Pool from Variable, Check Mode 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ content_var_ok }}"
        # content_format: var
        state: absent
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ var ]

    - name: Check TEST 235
      assert:
        that:
          - test|success
          - test|changed
      tags: [ var ]

#-------------------------------------------------------
    - name: "TEST 236 - Delete IP Pool from Variable, Check Mode 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ content_var_ok }}"
        # content_format: var
        state: absent
      register: test
      check_mode: yes
      ignore_errors: True
      tags: [ var ]

    - name: Check Init TEST 236
      assert:
        that:
          - test|success
          - test|changed
      tags: [ var ]

#-------------------------------------------------------
    - name: "TEST 237 - Delete IP Pool from Variable, 1/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ content_var_ok }}"
        # content_format: var
        state: absent
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ var ]

    - name: Check Init TEST 237
      assert:
        that:
          - test|success
          - test|changed
      tags: [ var ]

#-------------------------------------------------------
    - name: "TEST 238 - Delete IP Pool from Variable, 2/2"
      aos_ip_pool:
        session: "{{ session_ok }}"
        content: "{{ content_var_ok }}"
        # content_format: var
        state: absent
      register: test
      check_mode: no
      ignore_errors: True
      tags: [ var ]

    - name: Check Init TEST 238
      assert:
        that:
          - test|success
          - not test|changed
      tags: [ var ]
