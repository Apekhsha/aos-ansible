---
-   hosts: localhost
    gather_facts: false
    vars:
        blueprint_name: "{{ BLUEPRINT_NAME }}"

    tasks:
        - name: Make blueprint tmp directory on localhost
          file: dest="{{TMPDIR}}/{{blueprint_name}}" state=directory
          register: bp_dir

        - name: Login to AOS-server
          aos_login: server=aos-server
          register: aos

        - name: Get blueprint content for '{{blueprint_name}}'
          aos_blueprint_content:
            session: "{{aos.session}}"
            name: "{{blueprint_name}}"
          register: bp

        - name: Saving blueprint json
          copy:
            content: "{{bp.content}}"
            dest: "{{ bp_dir.path }}/blueprint.json"
          register: bp_file

        - name: Extract external router bgp information
          aos_blueprint_extract:
            extract: to_external_routers
            content: "{{ bp.content }}"
          register: bgp_data

        - name: Template build each router quagga config
          template:
            src: quagga_router.jinja2
            dest: "{{bp_dir.path}}/{{ item }}_quagga.conf"
          with_items: "{{ bgp_data.rtr_links }}"

        - name: Extract DHCP scopes for server subnets
          aos_blueprint_extract:
            extract: to_server_dhcp_scopes
            content: "{{bp.content}}"
          register: dhcpd_scopes

        - name: Saving dhcpd scopes json
          copy:
            content: "{{dhcpd_scopes}}"
            dest: "{{ bp_dir.path }}/dhcpd_scopes.json"

        - name: template build the DHCP scopes file
          template:
            src: isc-dhcpd-scopes.jinja2
            dest: "{{bp_dir.path}}/dhcpd_scopes_{{BLUEPRINT_NAME}}.conf"


-   hosts: ext-routers
    become: yes
    vars:
        bp_dir: "{{TMPDIR}}/{{BLUEPRINT_NAME}}"

    tasks:
        - name: Configure loopback address
          include: ipaddr_assign.yml iface=lo ipaddr=10.9.1.1/32

        - name: Configure interface addresses connected to blueprint
          include: ipaddr_assign.yml iface={{ item.value }} ipaddr={{ item.key }}
          with_dict: "{{IpAddrToPort}}"

        - name: Copy over Quagga.conf
          copy: src="{{bp_dir}}/{{inventory_hostname}}_quagga.conf"
                dest=/etc/quagga/Quagga.conf
          register: quagga_conf

        - name: Restart Quagga
          service: name=quagga state=restarted
          when: quagga_conf.changed


-   hosts: dhcpd-server
    become: yes
    vars:
        bp_dir: "{{TMPDIR}}/{{BLUEPRINT_NAME}}"

    tasks:
        - name: copy over DHCP server scopes file
          copy:
            src: "{{bp_dir}}/dhcpd_scopes_{{BLUEPRINT_NAME}}.conf"
            dest: /etc/dhcp/include_scopes
          register: dhcpd_scopes

        - name: Ensure scopes file is included
          lineinfile:
            dest: /etc/dhcp/include_scopes.conf
            regexp: "dhcpd_scopes_pod_1\\.conf"
            state: present
            line: include "/etc/dhcp/include_scopes/dhcpd_scopes_pod_1.conf";

        - name: Restart DHCP server to include new scopes
          service: name=isc-dhcp-server state=restarted
          when: dhcpd_scopes.changed



