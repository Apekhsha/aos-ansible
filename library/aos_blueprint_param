#!/usr/bin/env python

import json

from ansible.module_utils.basic import AnsibleModule

from apstra.aoscp.session import Session
from apstra.aoscp.exc import LoginError, SessionError

from apstra.aoscp.collection import CollectionValueTransformer
from apstra.aoscp.collection import CollectionValueMultiTransformer

def main():
    module = AnsibleModule(
        argument_spec=dict(
            session=dict(required=True, type="dict"),
            blueprint_name=dict(required=True),
            param_name=dict(required=True),
            param_map=dict(required=False, default="null"),
            param_value=dict(required=True, type="dict"),
            state=dict(choices=['present', 'absent', 'merged'], default='present'))
    )

    margs = module.params
    auth = margs['session']
    aos, blueprint, param = [None] * 3

    try:
        aos = Session()
        aos.api.resume(url=auth['url'], headers=auth['headers'])
    except LoginError as exc:
        module.fail_json(msg='unable to login to AOS API: %s' % str(exc))

    try:
        blueprint = aos.Blueprints[margs['blueprint_name']]
        param = blueprint.params[margs['param_name']]
    except SessionError as exc:
        module.fail_json(msg='unable to access param %s: %s' %
                             (margs['param_name'], str(exc)))

    try:
        param_value = margs['param_value']
        param_map = margs['param_map']
        param_map = json.loads(param_map)

        # if isinstance(param_map, dict):
        #     json.dump(param_map, open('/tmp/map-%s.json' % margs['param_name'], 'w+'), indent=3)
        # else:
        #     json.dump(param_map, open('/tmp/no-map-%s.json' % margs['param_name'], 'w+'), indent=3)
        #     if not param_map:
        #         module.fail_json(msg='there is no param-map provided')

        if param_map:
            if isinstance(param_map, dict):
                xf = CollectionValueMultiTransformer(aos, param_map)
            else:
                xf = CollectionValueTransformer(getattr(aos, param_map))
            param_value = xf.xf_out(param_value)

        param.value = param_value

    except SessionError as exc:
        module.fail_json(msg='unable to write to param %s: %s' %
                             (margs['param_name'], str(exc)))

    module.exit_json(changed=True)


main()
